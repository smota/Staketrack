<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StakeTrack - Stakeholder Management</title>
  <link rel="icon" href="assets/images/favicon.png" type="image/png">
  <!-- CSS -->
  <link rel="stylesheet" href="assets/css/reset.css">
  <link rel="stylesheet" href="assets/css/theme.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/utilities.css">
  <link rel="stylesheet" href="assets/css/components/button.css">
  <link rel="stylesheet" href="assets/css/components/card.css">
  <link rel="stylesheet" href="assets/css/components/form.css">
  <link rel="stylesheet" href="assets/css/components/matrix.css">
  <link rel="stylesheet" href="assets/css/components/modal.css">
  <link rel="stylesheet" href="assets/css/components/navbar.css">
  <link rel="stylesheet" href="assets/css/components/sidebar.css">
  <link rel="stylesheet" href="assets/css/components/tooltip.css">
  <link rel="stylesheet" href="assets/css/components/version.css">
</head>

<body>
  <header id="app-header">
    <nav class="navbar">
      <div class="navbar-logo">
        <img src="assets/images/logo.svg" alt="StakeTrack Logo">
      </div>
      <div class="navbar-actions">
        <div id="maps-dropdown-container" class="hidden">
          <select id="maps-dropdown" aria-label="Select Stakeholder Map">
            <option value="">Select a map...</option>
          </select>
          <button id="create-map-btn" class="btn btn-primary">New Map</button>
        </div>
        <div id="auth-container">
          <button id="login-btn" class="btn btn-secondary">Sign In</button>
          <div id="user-profile" class="hidden">
            <span id="user-email"></span>
            <button id="logout-btn" class="btn btn-text">Sign Out</button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main id="app-container">
    <div id="auth-view" class="view">
      <div class="auth-container">
        <h2>Sign in to StakeTrack</h2>
        <p>Sign in to save your stakeholder maps to the cloud</p>
        <div class="auth-providers">
          <button id="google-auth-btn" class="btn btn-provider">
            <span class="provider-icon">G</span>
            <span>Continue with Google</span>
          </button>
          <button id="microsoft-auth-btn" class="btn btn-provider">
            <span class="provider-icon">M</span>
            <span>Continue with Microsoft</span>
          </button>
        </div>
        <div class="auth-divider">
          <span>or</span>
        </div>
        <form id="email-auth-form">
          <div class="form-group">
            <label for="auth-email">Email</label>
            <input type="email" id="auth-email" required>
          </div>
          <div class="form-group">
            <label for="auth-password">Password</label>
            <input type="password" id="auth-password" required>
          </div>
          <button type="submit" id="email-auth-btn" class="btn btn-primary">Sign In</button>
        </form>
        <p class="auth-toggle">
          <span id="auth-toggle-text">Don't have an account?</span>
          <button id="auth-toggle-btn" class="btn btn-text">Sign Up</button>
        </p>
        <button id="skip-auth-btn" class="btn btn-text"
          onclick="document.getElementById('auth-view').classList.add('hidden'); document.getElementById('dashboard-view').classList.remove('hidden');">Continue
          without signing in</button>
      </div>
    </div>

    <div id="dashboard-view" class="view hidden">
      <div class="welcome-container">
        <h2>Welcome to StakeTrack</h2>
        <p>Get started by creating a new stakeholder map or select an existing one.</p>
        <button id="dashboard-create-map-btn" class="btn btn-primary">Create New Map</button>
        <div id="saved-maps-container" class="hidden">
          <h3>Your Maps</h3>
          <div id="saved-maps-list" class="maps-grid"></div>
        </div>
      </div>
    </div>

    <div id="map-view" class="view hidden">
      <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
          <h2 id="current-map-name">Stakeholder Map</h2>
          <button id="edit-map-btn" class="btn btn-icon" aria-label="Edit Map Details">
            <span class="icon">✏️</span>
          </button>
        </div>
        <div class="sidebar-actions">
          <button id="add-stakeholder-btn" class="btn btn-primary">Add Stakeholder</button>
          <button id="export-map-btn" class="btn btn-secondary">Export</button>
          <button id="import-map-btn" class="btn btn-secondary">Import</button>
          <button id="map-advice-btn" class="btn btn-accent">Get Best Next Action</button>
        </div>
        <div class="view-toggle">
          <button id="matrix-view-btn" class="btn btn-toggle active">Matrix View</button>
          <button id="list-view-btn" class="btn btn-toggle">List View</button>
        </div>
        <div id="stakeholders-list" class="stakeholders-container"></div>
      </aside>

      <section id="content-area" class="main-content">
        <div id="matrix-container" class="matrix-view-container">
          <div class="matrix-header">
            <h3>Stakeholder Influence-Impact Matrix</h3>
          </div>
          <div id="matrix" class="matrix">
            <div class="quadrant q1">
              <h4>Key Players</h4>
              <p>High Impact / High Influence</p>
            </div>
            <div class="quadrant q2">
              <h4>Meet Their Needs</h4>
              <p>High Impact / Low Influence</p>
            </div>
            <div class="quadrant q3">
              <h4>Show Consideration</h4>
              <p>Low Impact / Low Influence</p>
            </div>
            <div class="quadrant q4">
              <h4>Keep Satisfied</h4>
              <p>Low Impact / High Influence</p>
            </div>
            <div class="x-axis">Low Influence → High Influence</div>
            <div class="y-axis">Low Impact → High Impact</div>
            <div id="matrix-plots" class="matrix-plots"></div>
          </div>
        </div>

        <div id="list-container" class="list-view-container hidden">
          <div class="list-header">
            <h3>Stakeholders List</h3>
            <div class="list-filters">
              <select id="category-filter" aria-label="Filter by Category">
                <option value="">All Categories</option>
              </select>
              <select id="sort-by" aria-label="Sort Stakeholders">
                <option value="name">Name (A-Z)</option>
                <option value="influence">Influence (High-Low)</option>
                <option value="impact">Impact (High-Low)</option>
                <option value="relationship">Relationship (Strong-Weak)</option>
              </select>
            </div>
          </div>
          <div id="stakeholders-table-container">
            <table id="stakeholders-table" class="stakeholders-table">
              <thead>
                <tr>
                  <th>Name/Role</th>
                  <th>Influence</th>
                  <th>Impact</th>
                  <th>Relationship</th>
                  <th>Category</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="stakeholders-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modals -->
  <div id="modal-container" class="modal-container hidden">
    <div id="modal" class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Modal Title</h3>
        <button id="modal-close" class="btn btn-icon" aria-label="Close Modal">
          <span class="icon">✕</span>
        </button>
      </div>
      <div id="modal-content" class="modal-content"></div>
    </div>
  </div>

  <div id="tooltip" class="tooltip hidden"></div>

  <!-- Firebase error alert -->
  <div id="firebase-error-alert" class="hidden"
    style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #ffebee; color: #f44336; padding: 10px 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 9999; max-width: 80%;">
    <div style="display: flex; align-items: center;">
      <span style="margin-right: 10px; font-weight: bold;">⚠️</span>
      <span id="firebase-error-message">Firebase is not properly configured. You can still use the app without signing
        in.</span>
      <button id="firebase-error-close"
        style="margin-left: 15px; background: none; border: none; cursor: pointer; font-weight: bold;">✕</button>
    </div>
  </div>

  <!-- Templates -->
  <template id="stakeholder-form-template">
    <form id="stakeholder-form">
      <div class="form-group">
        <label for="stakeholder-name">Name/Role <span class="required">*</span></label>
        <input type="text" id="stakeholder-name" required
          data-tooltip="Enter the stakeholder's name and their role (e.g., 'John Smith - VP of Operations')">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="stakeholder-influence">Influence (1-10) <span class="required">*</span></label>
          <input type="range" id="stakeholder-influence" min="1" max="10" value="5"
            oninput="document.getElementById('influence-value').textContent = this.value" required
            data-tooltip="How much power does this stakeholder have in making decisions? (1=very little, 10=extremely high)">
          <span id="influence-value">5</span>
        </div>
        <div class="form-group">
          <label for="stakeholder-impact">Impact (1-10) <span class="required">*</span></label>
          <input type="range" id="stakeholder-impact" min="1" max="10" value="5"
            oninput="document.getElementById('impact-value').textContent = this.value" required
            data-tooltip="How much is this stakeholder affected by your initiative? (1=very little, 10=extremely high)">
          <span id="impact-value">5</span>
        </div>
      </div>
      <div class="form-group">
        <label for="stakeholder-relationship">Relationship Quality (1-10) <span class="required">*</span></label>
        <input type="range" id="stakeholder-relationship" min="1" max="10" value="5"
          oninput="document.getElementById('relationship-value').textContent = this.value" required
          data-tooltip="How strong is your relationship with this stakeholder? (1=very weak, 10=extremely strong)">
        <span id="relationship-value">5</span>
      </div>
      <div class="form-group">
        <label for="stakeholder-category">Category</label>
        <select id="stakeholder-category"
          data-tooltip="Select a category that best describes this stakeholder's role or position">
          <option value="executive">Executive</option>
          <option value="manager">Manager</option>
          <option value="team-member">Team Member</option>
          <option value="customer">Customer</option>
          <option value="partner">Partner</option>
          <option value="regulator">Regulator</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="stakeholder-interests">Primary Interests</label>
        <textarea id="stakeholder-interests"
          data-tooltip="What matters most to this stakeholder? What are their priorities, goals, and concerns?"></textarea>
      </div>
      <div class="form-group">
        <label for="stakeholder-contribution">Potential Contribution</label>
        <textarea id="stakeholder-contribution"
          data-tooltip="How can this stakeholder help your initiative succeed? What unique skills, resources, or influence can they bring?"></textarea>
      </div>
      <div class="form-group">
        <label for="stakeholder-risk">Risk if Disengaged</label>
        <textarea id="stakeholder-risk"
          data-tooltip="What could happen if this stakeholder becomes disengaged or opposes your initiative?"></textarea>
      </div>
      <div class="form-group">
        <label for="stakeholder-communication">Communication Style Preferences</label>
        <textarea id="stakeholder-communication"
          data-tooltip="How does this stakeholder prefer to communicate? (e.g., detailed emails, brief calls, formal meetings, informal chats)"></textarea>
      </div>
      <div class="form-group">
        <label for="stakeholder-strategy">Engagement Strategy</label>
        <textarea id="stakeholder-strategy"
          data-tooltip="Your approach to engaging with this stakeholder. How will you build/maintain the relationship?"></textarea>
      </div>
      <div class="form-group">
        <label for="stakeholder-measurement">Measurement Approach</label>
        <textarea id="stakeholder-measurement"
          data-tooltip="How will you measure the effectiveness of your engagement with this stakeholder?"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" id="cancel-stakeholder-btn" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </template>

  <template id="map-form-template">
    <form id="map-form">
      <div class="form-group">
        <label for="map-name">Map Name <span class="required">*</span></label>
        <input type="text" id="map-name" required
          data-tooltip="Give your stakeholder map a descriptive name (e.g., 'Project Alpha Stakeholders')">
      </div>
      <div class="form-group">
        <label for="map-description">Description</label>
        <textarea id="map-description"
          data-tooltip="Provide context about this stakeholder map. What project, initiative, or department is it for?"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" id="cancel-map-btn" class="btn btn-secondary">Cancel</button>
        <button type="button" id="delete-map-btn" class="btn btn-danger hidden">Delete Map</button>
      </div>
    </form>
  </template>

  <template id="interaction-log-template">
    <div class="interaction-log-container">
      <h3>Interaction Log for <span id="interaction-stakeholder-name"></span></h3>
      <div class="interaction-form">
        <textarea id="new-interaction" placeholder="Record a new interaction..."></textarea>
        <button id="add-interaction-btn" class="btn btn-primary">Add Entry</button>
      </div>
      <div id="interactions-list" class="interactions-list"></div>
    </div>
  </template>

  <template id="map-advice-template">
    <div class="advice-container">
      <h3>Next Best Action Recommendations</h3>
      <div id="advice-loading" class="loading-indicator">
        <span>Generating recommendations...</span>
      </div>
      <div id="advice-content" class="advice-content hidden"></div>
    </div>
  </template>

  <template id="stakeholder-advice-template">
    <div class="advice-container">
      <h3>Engagement Advice for <span id="advice-stakeholder-name"></span></h3>
      <div id="stakeholder-advice-loading" class="loading-indicator">
        <span>Generating advice...</span>
      </div>
      <div id="stakeholder-advice-content" class="advice-content hidden"></div>
    </div>
  </template>

  <!-- Initialize ENV and EventBus -->
  <script>
    // Initialize the ENV object
    window.ENV = {
      ENVIRONMENT: '',
      CONFIG_INCOMPLETE: true
    };

    // Initialize the EventBus
    window.EventBus = {
      events: {},
      subscribe: function (event, callback) {
        if (!this.events[event]) {
          this.events[event] = [];
        }
        this.events[event].push(callback);
        console.log(`EventBus: ${event} has ${this.events[event].length} listener(s)`);
        return () => this.unsubscribe(event, callback);
      },
      unsubscribe: function (event, callback) {
        if (this.events[event]) {
          this.events[event] = this.events[event].filter(cb => cb !== callback);
        }
      },
      emit: function (event, ...args) {
        console.log(`EventBus: Emitting '${event}' with args:`, args);
        if (this.events[event]) {
          console.log(`EventBus: '${event}' has ${this.events[event].length} listener(s)`);
          this.events[event].forEach(callback => {
            try {
              callback(...args);
            } catch (error) {
              console.error(`Error in ${event} event handler:`, error);
            }
          });
        } else {
          console.log(`EventBus: No listeners for '${event}'`);
        }
      }
    };
  </script>

  <!-- Firebase SDK - Load only once -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

  <!-- Dynamic Configuration Loader -->
  <script>
    /**
     * Dynamically loads Firebase configuration from server endpoint
     */
    async function loadEnvironmentConfig() {
      try {
        const hostname = window.location.hostname;
        let configEndpoint;
        let envName;

        // Determine environment based on hostname
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          configEndpoint = '/api/get-config?env=local';
          envName = 'local';
        } else if (hostname.includes('staketrack-dev.web.app') || hostname.includes('staketrack-dev.firebaseapp.com')) {
          configEndpoint = '/api/get-config?env=development';
          envName = 'development';
        } else if (hostname.includes('staketrack.com') || hostname.includes('staketrack.web.app')) {
          configEndpoint = '/api/get-config?env=production';
          envName = 'production';
        } else {
          configEndpoint = '/api/get-config?env=development';
          envName = 'development';
        }

        console.log(`Loading configuration for ${envName} environment from ${configEndpoint}`);

        try {
          // Try to load config from server endpoint
          const response = await fetch(configEndpoint);

          if (!response.ok) {
            throw new Error(`Failed to fetch configuration: ${response.status}`);
          }

          const config = await response.json();

          // Validate required fields
          if (!config || !config.firebase || !config.firebase.apiKey || !config.firebase.authDomain || !config.firebase.projectId) {
            throw new Error('Invalid configuration received from server');
          }

          // Update window.ENV
          Object.assign(window.ENV, {
            ENVIRONMENT: envName.toUpperCase(),
            FIREBASE_API_KEY: config.firebase.apiKey,
            FIREBASE_AUTH_DOMAIN: config.firebase.authDomain,
            FIREBASE_PROJECT_ID: config.firebase.projectId,
            FIREBASE_STORAGE_BUCKET: config.firebase.storageBucket,
            FIREBASE_MESSAGING_SENDER_ID: config.firebase.messagingSenderId,
            FIREBASE_APP_ID: config.firebase.appId,
            FIREBASE_MEASUREMENT_ID: config.firebase.measurementId,
            USE_EMULATORS: envName === 'local' ? 'true' : 'false',
            CONFIG_INCOMPLETE: false
          });

          console.log(`Environment loaded: ${config.ENVIRONMENT || envName}`);
          window.dispatchEvent(new CustomEvent('env:loaded', { detail: config }));

        } catch (error) {
          console.error(`Error loading configuration from API:`, error);

          // Use host-based config as fallback
          const hostConfig = getHostBasedConfig(hostname);
          Object.assign(window.ENV, hostConfig);

          console.log(`Using host-based config: ${hostConfig.ENVIRONMENT}`);
          window.dispatchEvent(new CustomEvent('env:loaded', { detail: hostConfig }));
        }
      } catch (error) {
        console.error('Fatal error in environment loading process:', error);

        // Create minimal default configuration
        const defaultConfig = {
          ENVIRONMENT: 'UNKNOWN',
          USE_EMULATORS: 'false',
          CONFIG_INCOMPLETE: true
        };

        Object.assign(window.ENV, defaultConfig);
        window.dispatchEvent(new CustomEvent('env:error', { detail: error }));
        window.dispatchEvent(new CustomEvent('env:loaded', { detail: defaultConfig }));
      }
    }

    /**
     * Get sensible defaults based on hostname
     */
    function getHostBasedConfig(hostname) {
      if (hostname.includes('staketrack-dev')) {
        return {
          ENVIRONMENT: 'DEV',
          CONFIG_INCOMPLETE: true,
          USE_EMULATORS: 'false'
        };
      } else if (hostname.includes('staketrack')) {
        return {
          ENVIRONMENT: 'PRD',
          CONFIG_INCOMPLETE: true
        };
      } else {
        return {
          ENVIRONMENT: hostname.includes('localhost') ? 'LOCAL' : 'UNKNOWN',
          USE_EMULATORS: hostname.includes('localhost') ? 'true' : 'false',
          CONFIG_INCOMPLETE: true
        };
      }
    }

    /**
     * Initialize Firebase based on environment configuration
     */
    function initializeFirebase() {
      try {
        const env = window.ENV;

        // Check if configuration is incomplete
        if (env.CONFIG_INCOMPLETE) {
          console.warn('Firebase configuration is incomplete. Authentication and database features will be disabled.');
          window.dispatchEvent(new CustomEvent('firebase:error', {
            detail: { err    new('Firebase configuration incomplete') }
          }));

          // Create dummy firebase implementations
          createDummyFirebaseImplementations();
          return;
        }

        // Firebase configuration
        const firebaseConfig = {
          apiKey: env.FIREBASE_API_KEY,
          authDomain: env.FIREBASE_AUTH_DOMAIN,
          projectId: env.FIREBASE_PROJECT_ID,
          storageBucket: env.FIREBASE_STORAGE_BUCKET,
          messagingSenderId: env.FIREBASE_MESSAGING_SENDER_ID,
          appId: env.FIREBASE_APP_ID,
          measurementId: env.FIREBASE_MEASUREMENT_ID
        };

        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }

        // Initialize services
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const analytics = env.ENVIRONMENT === 'PRD' ? firebase.analytics() : null;

        // Enable emulators for local development if needed
        if (env.ENVIRONMENT === 'LOCAL' && env.USE_EMULATORS === 'true') {
          console.log('Using Firebase emulators for local development');
          firestore.useEmulator('localhost', 8080);
          auth.useEmulator('http://localhost:9099');
        }

        // Make Firebase components available globally
        window.firebaseApp = firebase.app();
        window.firebaseAuth = auth;
        window.firebaseFirestore = firestore;
        window.firebaseAnalytics = analytics;

        // Dispatch event to signal Firebase is initialized
        window.dispatchEvent(new CustomEvent('firebase:initialized', {
          detail: { environment: env.ENVIRONMENT }
        }));
      } catch (error) {
        console.error('Firebase initialization error:', error);

        window.dispatchEvent(new CustomEvent('firebase:error', {
          detail: { error }
        }));

        // Create dummy implementations
        createDummyFirebaseImplementations();
      }
    }

    /**
     * Create dummy implementations of Firebase services for fallback
     */
    function createDummyFirebaseImplementations() {
      // Create dummy auth
      const auth = {
        onAuthStateChanged: (callback) => {
          setTimeout(() => callback(null), 100);
          return () => { };
        },
        signInWithEmailAndPassword: () => Promise.reject(new Error('Firebase not configured')),
        createUserWithEmailAndPassword: ()    Prom     eject(new Error('Firebase not configured')),
        signInWithPo     () => Promise.reject(new Error('Firebase not configured')),
          signOut: () => Promise.resolve(),
            currentUser: null
    };

    // Create dummy firestore
    const firestore = {
      collection: (collectionName) => ({
        doc: (docId) => ({
          get: () => Promise.resolve({
            exists: false,
            data: () => null,
            id: docId
          }),
          set: (data) => {
            console.log(`Mock save to ${collectionName}/${docId}:`, data);
            return Promise.resolve();
          },
          update: () => Promise.resolve()
        }),
        add: (data) => {
          const id = `local-${Date.now()}`;
          console.log(`Mock add to ${collectionName}:`, data);
          return Promise.resolve({ id });
        },
        where: () => ({
          get: () => Promise.resolve({
            empty: true,
            docs: [],
            forEach: () => { }
          })
        }),
        onSnapshot: (callback) => {
          callback({ empty: true, docs: [], forEach: () => { } });
          return () => { };
        }
      })
    };

    // Make dummy implementations available globally
    window.firebaseApp = null;
    window.firebaseAuth = auth;
    window.firebaseFirestore = firestore;
    window.firebaseAnalytics = {
      logEvent: () => { }
    };

    // Dispatch initialization event to allow application to continue
    window.dispatchEvent(new CustomEvent('firebase:initialized', {
      detail: { environment: window.ENV.ENVIRONMENT, dummy: true }
    }));
    }

    // Load config and then initialize Firebase
    loadEnvironmentConfig().then(() => {
      initializeFirebase();
    });
  </script>

  <!-- Application Scripts -->
  <script src="bundle.js"></script>

  <!-- Stakeholder Form Handler -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Setting up event handlers for stakeholder form');

      // Handler for stakeholder:show-form event
      window.EventBus.subscribe('stakeholder:show-form', function (stakeholderId) {
        console.log('Stakeholder form request received', stakeholderId);

        const modal = document.getElementById('modal');
        const modalContainer = document.tElemedal - container');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        if (!modal || !modalContainer || !modalTitle || !modalContent) {
          console.error('Modal elements not found in DOM');
          return;
        }

        modalTitle.textContent = stakeholderId ? 'Edit Stakeholder' : 'Add Stakeholder';

        const template = document.getElementById('stakeholder-form-template');
        if (!template) {
          console.error('Stakeholder form template not found');
          return;
        }

        const formContent = template.content.cloneNode(true);
        modalContent.innerHTML = '';
        modalContent.appendChild(formContent);

        // Setup form submission handler
        const form = document.getElementById('stakeholder-form');
        if (form) {
          form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Get form data
            const stakeholderData = {
              id: stakeholderId || `stakeholder-${Date.now()}`,
              name: document.getElementById('stakeholder-name').value,
              influence: parseInt(document.getElementById('stakeholder-influence').value),
              impact: parseInt(document.getElementById('stakeholder-impact').value),
              relationship: parseInt(document.getElementById('stakeholder-relationship').value),
              category: document.getElementById('stakeholder-category').value,
              interests: document.getElementById('stakeholder-interests').value,
              contribution: document.getElementById('stakeholder-contribution').value,
              risk: document.getElementById('stakeholder-risk').value,
              communication: document.getElementById('stakeholder-communication').value,
              strategy: document.getElementById('stakeholder-strategy').value,
              measurement: document.getElementById('stakeholder-measurement').value
            };

            try {
              if (window.stakeholderManager && typeof window.stakeholderManager.addStakeholder === 'function') {
                console.log('Using stakeholderManager to add stakeholder');
                await window.stakeholderManager.addStakeholder(stakeholderData);
              } else {
                console.log('Using localStorage fallback for stakeholder');
                // Get existing stakeholders
                const stakeholders = JSON.parse(localStorage.getItem('stakeholders') || '[]');

                // Add or update stakeholder
                const existingIndex = stakeholders.findIndex(s => s.id === stakeholderData.id);
                if (existingIndex >= 0) {
                  stakeholders[existingIndex] = stakeholderData;
                } else {
                  stakeholders.push(stakeholderData);
                }

                // Save back to localStorage
                localStorage.setItem('stakeholders', JSON.stringify(stakeholders));

                // Emit stakeholder:added event
                window.EventBus.emit('stakeholder:added', {
                  map: { id: 'default' },
                  stakeholder: stakeholderData
                });
              }

              // Close modal
              modalContainer.classList.add('hidden');
              modal.classList.add('hidden');
            } catch (error) {
              console.error('Error saving stakeholder:', error);
              alert('Failed to save stakeholder. Please try again.');
            }
          });
        }

        // Setup cancel button
        const cancelBtn = document.getElementById('cancel-stakeholder-btn');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', function () {
            modalContainer.classList.add('hidden');
            modal.classList.add('hidden');
          });
        }

        // Show modal
        modalContainer.classList.remove('hidden');
        modal.classList.remove('hidden');
      });

      // Ensure the Add Stakeholder button emits the correct event
      const addBtn = document.getElementById('add-stakeholder-btn');
      if (addBtn) {
        addBtn.addEventListener('click', function () {
          console.log('Add Stakeholder button clicked');
          window.EventBus.emit('stakeholder:show-form');
        });
      }

      // Close modal button handler
      const closeBtn = document.getElementById('modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function () {
          document.getElementById('modal-container').classList.add('hidden');
          document.getElementById('modal').classList.add('hidden');
        });
      }
    });
  </script>
</body>

</html>